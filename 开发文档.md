# AI模型管理工具 - 开发文档

## 项目概述

AI模型管理工具是一个基于Node.js的Web应用程序，用于管理多个AI服务提供商及其可用模型。系统支持多密钥轮换、模型自动检测、令牌使用统计、操作日志记录等功能，为用户提供一个统一的AI模型管理平台。

## 技术栈

- **后端**: Node.js + Express.js
- **数据库**: SQLite3
- **前端**: EJS模板引擎 + Bootstrap 5
- **其他依赖**: Axios (HTTP客户端)

## 项目结构

### 核心文件

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| index.js | 341行 | 主应用程序文件，负责初始化数据库和启动服务器 |
| server_start.js | 27行 | 服务器启动模块 |
| package.json | 928B | 项目配置和依赖管理 |

### 数据库相关

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| db_init.js | 3.0KB | 数据库初始化模块，创建表结构 |
| db_schema_update.js | 4.5KB | 数据库结构更新模块 |
| ai_models.db | 56.0KB | SQLite数据库文件(运行后自动创建) |
| src/services/database/index.js | 6.2KB | 数据库服务模块，提供统计、优化和备份功能 |
| src/services/database/migrations.js | 5.8KB | 数据库迁移模块，管理数据库版本和结构变更 |
| routes/database.js | 3.2KB | 数据库管理路由，提供数据库管理API端点 |

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| db_init.js | 2.5KB | 数据库初始化模块，创建表结构 |
| db_schema_update.js | 4.1KB | 数据库结构更新模块 |
| ai_models.db | 56.0KB | SQLite数据库文件(运行后自动创建) |

### 模型分析器

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| modelAnalyzer.js | 781行 | 基础模型分析器，用于检测单个提供商的模型 |
| modelAnalyzer_enhanced.js | 492行 | 增强模型分析器，支持智能轮换策略 |

### 工具模块

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| api_checker.js | 6.3KB | API可用性检查模块 |
| memory_manager.js | 5.5KB | 内存管理模块 |
| token_usage.js | 2.4KB | 令牌使用记录模块 |
| app_init.js | 938B | 应用程序初始化模块 |

### 路由模块

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| routes/index.js | 6.8KB | 主页和模型路由 |
| routes/providers.js | 7.7KB | 提供商管理路由 |
| routes/api_keys.js | 6.9KB | API密钥管理路由 |
| routes/key_stats.js | 4.9KB | API密钥统计路由 |
| routes/logs.js | 7.9KB | 操作日志路由 |
| routes/models_list.js | 6.8KB | 模型列表路由 |
| routes/health.js | 5.5KB | 健康检查路由 |
| routes/token_logs.js | 7.5KB | 令牌日志路由 |
| routes/scheduler.js | 约6KB | 定时任务管理路由 |

### 前端资源

| 文件名 | 大小 | 功能描述 |
|--------|------|----------|
| views/index.ejs | 40.0KB | 首页模板 |
| views/add-provider.ejs | 7.4KB | 添加提供商页面模板 |
| views/edit-provider.ejs | 7.7KB | 编辑提供商页面模板 |
| views/api-keys.ejs | 8.7KB | API密钥管理模板 |
| views/key-stats.ejs | 15.8KB | API密钥统计模板 |
| views/logs.ejs | 8.6KB | 操作日志模板 |
| public/css/style.css | 1.6KB | 自定义样式文件 |

## API接口说明

### 1. 提供商管理

#### 添加提供商
- **路径**: `POST /providers/add-provider`
- **参数**:
  - `name`: 提供商名称（可选，默认为“提供商 + 时间戳”）
  - `url`: 主API接口地址（必填）
  - `apiKeys[]`: API密钥数组
  - `endpoints[]`: 其他API接口地址数组
- **功能**: 添加新的AI服务提供商。系统将自动按顺序为接口和密钥命名，并立即触发模型检测。

#### 删除提供商
- **路径**: `POST /providers/delete-provider/:id`
- **参数**: 
  - `id`: 提供商ID
- **功能**: 删除指定提供商及其所有模型

#### 检测所有提供商模型
- **路径**: `POST /detect-all-models`
- **功能**: 手动触发所有提供商的模型检测

### 2. API密钥管理

#### 获取提供商API密钥列表
- **路径**: `GET /provider/:id/api-keys`
- **参数**: 
  - `id`: 提供商ID
- **功能**: 获取指定提供商的所有API密钥

#### 添加API密钥
- **路径**: `POST /provider/:id/api-keys/add`
- **参数**: 
  - `id`: 提供商ID
  - `keyName`: 密钥名称
  - `apiKey`: API密钥
- **功能**: 为指定提供商添加新的API密钥

#### 删除API密钥
- **路径**: `POST /api-keys/:id/delete`
- **参数**: 
  - `id`: API密钥ID
- **功能**: 删除指定的API密钥

#### 切换API密钥状态
- **路径**: `POST /api-keys/:id/toggle`
- **参数**: 
  - `id`: API密钥ID
- **功能**: 启用或禁用指定的API密钥

### 3. 模型管理

#### 列出所有可用模型
- **路径**: `GET /v1/models`
- **功能**: 返回所有提供商的可用模型列表，格式兼容OpenAI API
- **返回格式**: 
  ```json
  {
    "object": "list",
    "data": [
      {
        "id": "model-id",
        "object": "model",
        "created": null,
        "owned_by": "provider-name"
      },
      ...
    ]
  }```

#### 列出特定提供商的模型
- **路径**: `GET /v1/models/:providerId`
- **参数**: 
  - `providerId`: 提供商ID
- **功能**: 返回指定提供商的可用模型列表
- **返回格式**: 
  ```json
  {
    "object": "list",
    "data": [
      {
        "id": "model-id",
        "object": "model",
        "created": null,
        "owned_by": "provider-name"
      },
      ...
    ]
  }```

### 4. 健康检查

#### 系统健康状态
- **路径**: `GET /health`
- **功能**: 返回系统健康状态、内存使用情况等信息

#### 最近健康检查结果
- **路径**: `GET /health-status`
- **功能**: 返回最近一次健康检查的结果

#### 实时内存状态
- **路径**: `GET /memory-status`
- **功能**: 返回实时内存使用情况

#### 手动内存清理
- **路径**: `POST /cleanup-memory`
- **功能**: 手动触发内存清理

### 5. 日志管理

#### 查看操作日志
- **路径**: `GET /logs`
- **参数**: 
  - `page`: 页码
  - `type`: 操作类型筛选
- **功能**: 查看系统操作日志

#### 清理日志
- **路径**: `POST /clear-logs`
- **参数**: 
  - `days`: 保留天数
- **功能**: 清理超过指定天数的日志

#### 导出日志
- **路径**: `GET /export-logs`
- **参数**: 
  - `format`: 导出格式(json/csv)
  - `type`: 操作类型筛选
  - `days`: 导出天数
- **功能**: 导出指定条件的日志

### 6. 模型列表 API (前端专用)

#### 获取前端可用模型列表
- **路径**: `GET /api/models`
- **功能**: 获取当前所有提供商及其支持的模型 ID 列表，用于前端 Dashboard 展示
- **成功响应**:
  ```json
  {
    "success": true,
    "data": {
      "1": ["gpt-3.5-turbo", "gpt-4"],
      "2": ["claude-3-sonnet", "claude-3-haiku"]
    }
  }
  ```

### 7. 令牌使用统计

#### 获取令牌使用日志
- **路径**: `GET /api/log/token`
- **参数**: 
  - `page`: 页码
  - `limit`: 每页数量
  - `providerId`: 提供商ID筛选
  - `modelId`: 模型ID筛选
  - `startDate`: 开始日期
  - `endDate`: 结束日期
- **功能**: 获取令牌使用日志，支持分页和筛选

#### 获取令牌使用统计
- **路径**: `GET /api/log/token/stats`
- **参数**: 
  - `providerId`: 提供商ID筛选
  - `modelId`: 模型ID筛选
  - `days`: 统计天数
- **功能**: 获取令牌使用统计信息

### 7. 定时任务管理

#### 定时任务管理页面
- **路径**: `GET /scheduler`
- **功能**: 显示定时任务管理页面，包括任务状态和手动执行选项

#### 启动调度器
- **路径**: `POST /scheduler/start`
- **功能**: 启动定时任务调度器

#### 停止调度器
- **路径**: `POST /scheduler/stop`
- **功能**: 停止定时任务调度器

#### 手动执行模型检测
- **路径**: `POST /scheduler/execute/model-detection`
- **功能**: 手动触发模型检测任务

#### 手动执行健康检查
- **路径**: `POST /scheduler/execute/health-check`
- **功能**: 手动触发健康检查任务

#### 手动执行日志清理
- **路径**: `POST /scheduler/execute/log-cleanup`
- **功能**: 手动触发日志清理任务

#### 获取定时任务状态
- **路径**: `GET /api/scheduler/status`
- **功能**: 获取定时任务状态信息

## 代码规范

### 文件大小限制

1. **所有文件**: 不应超过750行，超过应考虑拆分
2. **路由文件**: 建议不超过10KB，超过应考虑拆分
3. **核心模块文件**: 建议不超过50KB
4. **工具模块文件**: 建议不超过10KB
5. **前端模板文件**: 建议不超过40KB，超过应考虑组件化

### 命名规范

1. **文件命名**: 使用小写字母和下划线，如 `api_keys.js`
2. **函数命名**: 使用驼峰命名法，如 `getAvailableApiKey`
3. **变量命名**: 使用驼峰命名法，如 `providerId`
4. **常量命名**: 使用大写字母和下划线，如 `MAX_REQUESTS_PER_KEY`

### 代码结构

1. **路由文件结构**:
   ```javascript
   const express = require('express');
   const router = express.Router();

   // 路由定义...

   module.exports = router;
   ```

2. **模块文件结构**:
   ```javascript
   const someModule = require('...');

   // 私有函数...

   // 公共函数...

   module.exports = {
       // 导出的函数...
   };
   ```

3. **错误处理**:
   ```javascript
   try {
       // 主要逻辑...
   } catch (error) {
       console.error('操作失败:', error);
       logOperation(db, 'OPERATION', 'target', id, name, `操作失败: ${error.message}`, 'error', req);
       return res.status(500).json({ error: error.message });
   }
   ```

## 数据库设计

### 主要表结构

1. **providers** - 提供商表
   - id: 主键
   - name: 提供商名称
   - url: API地址
   - api_key: 默认API密钥
   - created_at: 创建时间

2. **api_keys** - API密钥表
   - id: 主键
   - provider_id: 提供商ID(外键)
   - key_name: 密钥名称
   - api_key: API密钥
   - is_active: 是否启用
   - created_at: 创建时间

3. **models** - 模型表
   - id: 主键
   - provider_id: 提供商ID(外键)
   - model_name: 模型名称
   - model_id: 模型ID
   - description: 模型描述
   - category: 模型类别
   - context_window: 上下文窗口大小
   - capabilities: 模型能力(JSON)

4. **operation_logs** - 操作日志表
   - id: 主键
   - operation_type: 操作类型
   - target_type: 目标类型
   - target_id: 目标ID
   - target_name: 目标名称
   - details: 操作详情
   - user_ip: 用户IP
   - user_agent: 用户代理
   - status: 操作状态
   - created_at: 创建时间

5. **token_logs** - 令牌使用日志表
   - id: 主键
   - provider_id: 提供商ID(外键)
   - model_id: 模型ID
   - api_key_id: API密钥ID(外键)
   - request_tokens: 请求令牌数
   - response_tokens: 响应令牌数
   - total_tokens: 总令牌数
   - cost: 成本
   - request_time: 请求时间
   - response_time_ms: 响应时间(毫秒)
   - status: 请求状态
   - error_message: 错误信息

## 开发指南

### 添加新的AI服务提供商

1. 在`modelAnalyzer.js`中的`detectModels`方法中添加对新提供商的支持
2. 根据提供商API规范实现模型检测逻辑
3. 更新前端UI以显示新提供商的特定信息

### 添加新的API接口

1. 在`routes`目录下创建新的路由文件或在现有文件中添加路由
2. 实现路由处理函数，包括参数验证、业务逻辑处理和错误处理
3. 更新前端UI以调用新的API接口

### 数据库结构更新

1. 在`db_schema_update.js`中添加数据库结构更新逻辑
2. 实现向前兼容的数据迁移
3. 更新相关模型和路由以支持新的字段或表

## 部署说明

### 环境要求

- Node.js 16或更高版本
- SQLite3
- 足够的磁盘空间用于数据库和日志存储

### 启动步骤

1. 安装依赖: `npm install`
2. 初始化数据库: `node db_init.js`
3. 启动应用: `npm start` 或 `node server_start.js`
4. 访问应用: http://localhost:3000

### 生产环境配置

1. 设置环境变量:
   - `PORT`: 服务器端口
   - `NODE_ENV`: 环境模式(production)
   - `HEALTH_CHECK_URL`: 健康检查URL

2. 配置反向代理(如Nginx)
3. 设置进程管理器(如PM2)
4. 定期备份数据库

## 常见问题

### 1. 模型检测失败

- 检查API密钥是否正确
- 确认提供商API地址是否可访问
- 查看错误日志获取详细信息

### 2. 内存使用过高

- 使用`/cleanup-memory`接口手动清理内存
- 调整内存管理器的清理阈值
- 考虑增加系统内存

### 3. 数据库锁定

- 检查是否有长时间运行的查询
- 重启应用释放数据库连接
- 考虑优化数据库查询

## 更新日志

### v1.0.0
- 初始版本发布
- 基本的提供商和模型管理功能
- API密钥管理
- 操作日志记录

### v1.1.0
- 添加多密钥支持
- 实现智能密钥轮换策略
- 添加令牌使用统计功能
- 优化UI界面

### v1.2.0
- 添加健康检查功能
- 实现内存管理模块
- 优化模型检测性能
- 添加数据导入导出功能

### v1.3.0
- 添加定时任务功能
- 实现自动模型检测
- 添加定时日志清理
- 实现定时健康检查

### v1.5.0 (最新)
- **代码重构**: 确保所有文件不超过800行，提高代码可维护性。删除重复和冗余文件，统一使用ESM模块系统。
- **模块化设计**: 采用ESM模块系统，将功能分离到不同模块中，包括路由(routes/)、服务(src/services/)和工具(src/utils/)。
- **文档更新**: 更新开发文档，记录文件拆分和新的代码规范。
- **API检查优化**: 实现API检查失败三次后自动跳过检查的机制，避免过多重试浪费资源。
- **密钥显示修复**: 修复了编辑提供商时无法查看之前密钥的问题，现在即使提供商表中有主密钥但不在API密钥表中，也会自动添加显示，确保用户可以看到所有之前填写的密钥。
- **表单数据持久化**: 修复了编辑提供商时官方网址和API接口地址保存后再次编辑变成空的问题，现在会保持之前填写的值。
- **错误修复**: 修复了编辑提供商页面中"savedForm is not defined"的错误，添加了默认对象处理。
- **表单数据持久化增强**: 使用localStorage技术，确保添加和编辑提供商时，之前填写的所有信息都能在页面刷新或重新打开后显示。

### v1.4.0
- **界面简化**: 隐藏了提供商、接口和密钥的名称输入，改为后端自动命名。
- **智能纠错**: 实现了 API 路径自动去重逻辑，解决重复拼接 `/v1` 或 `/api` 导致的 404 错误。
- **检测增强**: `api_checker` 现在优先探测 `/models` 端点并自动携带认证密钥，大幅降低可用性误报。
- **排序优化**: 所有列表默认按创建时间倒序排列。

### v2.0.0

- **测试框架**: 添加Jest测试框架，支持单元测试和集成测试。
- **文档完善**: 创建浏览器自动化模块详细文档（docs/browser-automation.md）。
- **测试指南**: 创建测试指南文档（TESTING.md），说明如何运行和编写测试。
- **代码质量**: 添加测试覆盖率和代码质量检查。
- **模块清理**: 删除重复和冗余文件，统一使用ESM模块系统。
- **文件规范**: 确保所有文件不超过800行，提高代码可维护性。
- **代码修复**: 修复memory_manager.js中的重复export语句，解决TypeScript类型检查错误。

### 测试

项目现在包含完整的测试套件，覆盖以下模块：

- 提取器测试（tests/extractors/）
  - base.test.js - 基础提取器测试
  - dom.test.js - DOM提取器测试
  - deep.test.js - 深度提取器测试
  - hybrid.test.js - 混合提取器测试

- 工作流测试（tests/workflow/）
  - executor.test.js - 工作流执行器测试

- 流监控测试（tests/streamMonitor/）
  - monitor.test.js - 流监控器测试

运行测试：
```bash
npm test              # 运行所有测试
npm run test:watch  # 监听模式
npm run test:coverage  # 生成覆盖率报告
```

### 文档

项目文档位于`docs/`目录：

- **browser-automation.md**: 浏览器自动化模块详细文档
  - 架构说明
  - 模块功能描述
  - 添加新网站支持指南
  - 最佳实践和故障排除

- **TESTING.md**: 测试指南
  - 测试运行说明
  - 测试编写指南
  - 覆盖率目标
