# 项目代码问题修复与API完善计划（含使用模式区分）

## 阶段一：代码质量修复（高优先级）

### 1.1 TypeScript类型安全
- 修复 `tsconfig.json`，启用严格模式
- 移除所有 `@ts-ignore`，添加正确的类型注解
- 为 `global.d.ts` 和 `types/index.d.ts` 添加完整类型定义
- 修复所有隐式 `any` 类型错误

### 1.2 ESLint错误修复
- 移除未使用的变量（browser.js:65）
- 修复变量命名冲突（database.js）
- 修复所有 ESLint 警告

### 1.3 错误处理统一
- 统一错误处理中间件，移除重复代码
- 为所有异步操作添加 try-catch
- 统一错误响应格式（统一使用 JSON）
- 完善数据库、文件、网络操作的错误处理

### 1.4 代码去重
- 创建统一的数据库连接获取工具函数
- 创建统一的日志记录工具函数
- 合并重复的 Cookie 管理逻辑
- 移除重复的错误处理代码

## 阶段二：使用模式配置系统（高优先级）

### 2.1 添加使用模式配置
- 在 `config/app.json` 中添加 `usage_mode` 配置项（personal/service）
- 在 `src/services/config/index.js` 中添加模式获取方法
- 添加模式切换API接口

### 2.2 个人模式配置（性能最大化）
- 禁用所有限流
- 禁用请求队列
- 启用所有并发请求
- 禁用缓存（实时性优先）
- 禁用熔断机制
- 最大化浏览器资源（不阻止任何资源）
- 禁用会话隔离

### 2.3 服务模式配置（可调节）
- 启用请求限流（可配置限流阈值）
- 启用请求队列（可配置队列大小）
- 限制并发请求数（可配置）
- 启用响应缓存（可配置缓存时间）
- 启用熔断机制（可配置熔断阈值）
- 优化浏览器资源（可配置资源阻止规则）
- 启用会话隔离

### 2.4 模式动态切换
- 实现运行时模式切换
- 添加模式切换时的资源清理
- 添加模式切换日志记录

## 阶段三：Web转本地API服务完善（高优先级）

### 3.1 多标签页管理
- 在 browser/connection.js 中添加多标签页支持
- 实现标签页创建、切换、关闭功能
- 添加标签页状态管理
- **根据使用模式调整**：个人模式无限制，服务模式限制标签页数量

### 3.2 并发请求处理
- 实现请求队列机制
- 添加并发控制（限制同时处理的请求数）
- 实现请求优先级
- **根据使用模式调整**：个人模式无限制，服务模式可配置并发数

### 3.3 会话管理
- 实现独立的会话隔离
- 添加会话状态管理
- 支持多用户并发访问
- **根据使用模式调整**：个人模式禁用会话隔离，服务模式启用

### 3.4 代理支持
- 添加代理配置选项
- 支持HTTP/HTTPS/SOCKS代理
- 实现代理切换功能
- **根据使用模式调整**：个人模式可选，服务模式推荐启用

### 3.5 错误恢复增强
- 添加重试次数限制
- 实现智能重试策略
- 添加错误恢复日志
- **根据使用模式调整**：个人模式快速重试，服务模式限制重试次数

## 阶段四：统一API接口增强（中优先级）

### 4.1 请求限流（服务模式专用）
- 实现基于IP的限流（可配置）
- 实现基于API密钥的限流（可配置）
- 添加限流统计
- **个人模式自动禁用**

### 4.2 缓存机制（服务模式专用）
- 实现响应缓存（可配置缓存时间）
- 添加缓存失效策略
- 支持缓存预热
- **个人模式自动禁用**

### 4.3 请求重试
- 实现自动重试机制
- 添加指数退避策略
- 支持自定义重试配置
- **根据使用模式调整**：个人模式快速重试，服务模式限制重试次数

### 4.4 熔断机制（服务模式专用）
- 实现熔断器模式
- 添加熔断状态管理
- 支持自动恢复
- **个人模式自动禁用**

### 4.5 监控指标
- 添加请求统计
- 添加响应时间监控
- 添加错误率统计
- 实现性能指标API
- **根据使用模式调整**：个人模式简化监控，服务模式详细监控

### 4.6 负载均衡（服务模式专用）
- 实现多提供商负载均衡
- 添加健康检查
- 支持权重配置
- **个人模式使用第一个可用提供商**

### 4.7 API版本管理
- 实现API版本路由
- 添加版本兼容性检查
- 支持版本弃用通知

## 阶段五：API接口完善（中优先级）

### 5.1 批量操作API
- 添加批量删除提供商API
- 添加批量启用/禁用API密钥API
- 添加批量导入/导出API

### 5.2 统计和监控API
- 添加API密钥使用统计API
- 添加模型调用频率统计API
- 添加提供商性能对比API
- 添加实时监控仪表板API
- **根据使用模式调整**：服务模式提供详细统计，个人模式提供基础统计

### 5.3 配置管理API
- 添加动态修改浏览器常量API
- 添加修改日志级别API
- 添加配置热更新API
- **添加使用模式切换API**

### 5.4 OAuth完整API
- 添加OAuth提供商CRUD API
- 添加OAuth授权状态查询API
- 添加OAuth Token刷新策略配置API

### 5.5 Cookie管理完整API
- 添加Cookie过期时间设置API
- 添加Cookie导入验证API
- 添加Cookie批量操作API

## 阶段六：测试与文档（低优先级）

### 6.1 测试
- 运行所有现有测试
- 修复测试失败
- 添加新功能的测试
- 测试两种使用模式

### 6.2 文档
- 更新API文档
- 添加新功能使用示例
- 更新开发文档
- **添加使用模式配置文档**

## 核心特性：使用模式自动适配

### 配置文件示例（config/app.json）
```json
{
  "usage_mode": "personal",  // "personal" | "service"
  "performance": {
    "personal": {
      "rate_limit": false,
      "concurrent_requests": -1,  // 无限制
      "cache_enabled": false,
      "circuit_breaker": false,
      "max_tabs": -1,
      "session_isolation": false
    },
    "service": {
      "rate_limit": {
        "enabled": true,
        "requests_per_minute": 60,
        "requests_per_hour": 1000
      },
      "concurrent_requests": 5,
      "cache_enabled": true,
      "cache_ttl": 300,
      "circuit_breaker": {
        "enabled": true,
        "failure_threshold": 5,
        "recovery_timeout": 60000
      },
      "max_tabs": 10,
      "session_isolation": true
    }
  }
}
```

### API接口示例
```javascript
// 切换使用模式
POST /api/config/usage-mode
{
  "mode": "service",  // "personal" | "service"
  "service_config": {
    "rate_limit": {
      "requests_per_minute": 100
    }
  }
}

// 获取当前模式
GET /api/config/usage-mode
```

## 预计工作量
- 阶段一：约2-3小时
- 阶段二：约2-3小时
- 阶段三：约3-4小时
- 阶段四：约4-5小时
- 阶段五：约2-3小时
- 阶段六：约1-2小时

**总计：约14-20小时**