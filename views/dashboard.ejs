<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表盘 - AI模型管理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container py-6">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="mb-1">
                    <i class="bi bi-speedometer2"></i> 仪表盘
                </h1>
                <p class="text-muted mb-0">系统概览和实时状态</p>
            </div>
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>

        <!-- 统计卡片 -->
        <div class="row g-4 mb-5">
            <div class="col-md-3 col-6">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon stat-icon-primary">
                                <i class="bi bi-building"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small">提供商总数</p>
                                <h3 class="mb-0" id="statProviders">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon stat-icon-success">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small">可用模型</p>
                                <h3 class="mb-0" id="statModels">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon stat-icon-info">
                                <i class="bi bi-chat-dots"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small">今日请求</p>
                                <h3 class="mb-0" id="statRequests">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon stat-icon-warning">
                                <i class="bi bi-currency-yen"></i>
                            </div>
                            <div>
                                <p class="text-muted mb-0 small">今日成本</p>
                                <h3 class="mb-0"><small>¥</small><span id="statCost">-</span></h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API状态 -->
        <div class="row g-4 mb-5">
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-activity me-2"></i>API健康状态</h5>
                    </div>
                    <div class="card-body">
                        <div id="apiStatusList">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-arrow-clockwise spin"></i> 加载中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>系统状态</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-arrow-clockwise spin"></i> 加载中...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Token使用排行 -->
        <div class="card border-0 shadow-sm mb-5">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Token使用排行</h5>
                <a href="/billing" class="btn btn-sm btn-outline-primary">
                    查看详情 <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            <div class="card-body">
                <div id="tokenRanking">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-arrow-clockwise spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>

        <!-- 快捷操作 -->
        <div class="row g-4">
            <div class="col-md-3 col-6">
                <a href="/add-provider" class="card stat-card border-0 shadow-sm text-decoration-none text-dark">
                    <div class="card-body text-center">
                        <div class="stat-icon stat-icon-primary mx-auto mb-3">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <h6 class="mb-0">添加提供商</h6>
                    </div>
                </a>
            </div>
            <div class="col-md-3 col-6">
                <a href="/browser" class="card stat-card border-0 shadow-sm text-decoration-none text-dark">
                    <div class="card-body text-center">
                        <div class="stat-icon stat-icon-success mx-auto mb-3">
                            <i class="bi bi-browser-chrome"></i>
                        </div>
                        <h6 class="mb-0">浏览器自动化</h6>
                    </div>
                </a>
            </div>
            <div class="col-md-3 col-6">
                <button class="card stat-card border-0 shadow-sm w-100" onclick="testAllApis()">
                    <div class="card-body text-center">
                        <div class="stat-icon stat-icon-info mx-auto mb-3">
                            <i class="bi bi-activity"></i>
                        </div>
                        <h6 class="mb-0">测试所有API</h6>
                    </div>
                </button>
            </div>
            <div class="col-md-3 col-6">
                <a href="/logs" class="card stat-card border-0 shadow-sm text-decoration-none text-dark">
                    <div class="card-body text-center">
                        <div class="stat-icon stat-icon-warning mx-auto mb-3">
                            <i class="bi bi-journal-text"></i>
                        </div>
                        <h6 class="mb-0">操作日志</h6>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <style>
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:has(a):hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .stat-icon-primary {
            background: var(--primary-50);
            color: var(--primary-color);
        }
        .stat-icon-success {
            background: var(--success-bg);
            color: var(--success-color);
        }
        .stat-icon-info {
            background: var(--info-bg);
            color: var(--info-color);
        }
        .stat-icon-warning {
            background: var(--warning-bg);
            color: var(--warning-color);
        }
        .api-status-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }
        .api-status-item:last-child {
            border-bottom: none;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.75rem;
        }
        .status-dot.online { background: var(--success-color); }
        .status-dot.offline { background: var(--danger-color); }
        .status-dot.unknown { background: var(--warning-color); }
        .token-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
        }
        .token-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .token-rank.top-3 {
            background: var(--warning-bg);
            color: var(--warning-color);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
    <script>
        // 刷新仪表盘
        function refreshDashboard() {
            loadStats();
            loadApiStatus();
            loadSystemStatus();
            loadTokenRanking();
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const response = await fetch('/api-dashboard-stats');
                const data = await response.json();

                document.getElementById('statProviders').textContent = data.providers || 0;
                document.getElementById('statModels').textContent = data.models || 0;
                document.getElementById('statRequests').textContent = data.requests || 0;
                document.getElementById('statCost').textContent = (data.cost || 0).toFixed(2);
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载API状态
        async function loadApiStatus() {
            try {
                const response = await fetch('/api-status');
                const data = await response.json();

                const container = document.getElementById('apiStatusList');
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4">暂无API提供商</div>';
                    return;
                }

                container.innerHTML = data.map(api => {
                    const statusClass = api.status === 'available' ? 'online' : api.status === 'unavailable' ? 'offline' : 'unknown';
                    const statusText = api.status === 'available' ? '在线' :
                                      api.status === 'unavailable' ? '离线' : '未知';
                    const responseTime = api.responseTime ? ` (${api.responseTime}ms)` : '';

                    return `
                        <div class="api-status-item">
                            <div class="status-dot ${statusClass}"></div>
                            <div class="flex-grow-1">
                                <div class="fw-medium">${api.provider}</div>
                                <small class="text-muted">${api.url}</small>
                            </div>
                            <span class="badge bg-${api.status === 'available' ? 'success' : api.status === 'unavailable' ? 'danger' : 'secondary'}">
                                ${statusText}${responseTime}
                            </span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载API状态失败:', error);
                document.getElementById('apiStatusList').innerHTML =
                    '<div class="text-center text-muted py-4">加载失败</div>';
            }
        }

        // 加载系统状态
        async function loadSystemStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();

                const container = document.getElementById('systemStatus');
                const isHealthy = data.status === 'ok' || data.status === 'healthy';

                // 计算运行时间和内存使用
                const uptimeSeconds = data.uptime?.seconds || 0;
                const uptimeMinutes = Math.floor(uptimeSeconds / 60);

                // 解析内存字符串
                const heapUsedMatch = data.memory?.heapUsed?.match(/(\d+)/);
                const heapTotalMatch = data.memory?.heapTotal?.match(/(\d+)/);
                const heapUsed = heapUsedMatch ? parseInt(heapUsedMatch[1]) : 0;
                const heapTotal = heapTotalMatch ? parseInt(heapTotalMatch[1]) : 0;

                container.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">数据库状态</small>
                            <span class="badge bg-success">已连接</span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">运行时间</small>
                            <small>${uptimeMinutes} 分钟</small>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">内存使用</small>
                            <small>${heapUsed} MB / ${heapTotal} MB</small>
                        </div>
                    </div>
                    <div class="alert alert-${isHealthy ? 'success' : 'danger'} mb-0">
                        <i class="bi bi-${isHealthy ? 'check-circle' : 'x-circle'} me-1"></i>
                        ${isHealthy ? '系统运行正常' : '系统异常'}
                    </div>
                `;
            } catch (error) {
                console.error('加载系统状态失败:', error);
                document.getElementById('systemStatus').innerHTML =
                    '<div class="alert alert-warning mb-0"><i class="bi bi-exclamation-triangle me-1"></i>无法获取系统状态</div>';
            }
        }

        // 加载Token使用排行
        async function loadTokenRanking() {
            try {
                const response = await fetch('/token-ranking');
                const data = await response.json();

                const container = document.getElementById('tokenRanking');
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4">暂无Token使用记录</div>';
                    return;
                }

                container.innerHTML = `
                    <div class="row g-2">
                        ${data.map((item, index) => `
                            <div class="col-md-6">
                                <div class="token-item">
                                    <div class="token-rank ${index < 3 ? 'top-3' : ''}">${index + 1}</div>
                                    <div class="flex-grow-1">
                                        <div class="fw-medium truncate">${item.model}</div>
                                        <small class="text-muted">${item.requests} 次请求</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-medium">${item.tokens.toLocaleString()}</div>
                                        <small class="text-muted">Tokens</small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('加载Token排行失败:', error);
                document.getElementById('tokenRanking').innerHTML =
                    '<div class="text-center text-muted py-4">加载失败</div>';
            }
        }

        // 测试所有API
        async function testAllApis() {
            try {
                const btn = event.target.closest('button');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> 测试中';
                btn.disabled = true;

                const response = await fetch('/test-all-connections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                alert(result.message);
                loadApiStatus();
            } catch (error) {
                alert('测试失败: ' + error.message);
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            refreshDashboard();

            // 每60秒自动刷新
            setInterval(refreshDashboard, 60000);
        });
    </script>
</body>
</html>
